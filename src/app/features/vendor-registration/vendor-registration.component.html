<div class="container m-0">
  <!-- File Upload Section -->
  <div class="file-upload-container">
    <label for="file-input" class="custom-file-label">
      <mat-icon>cloud_upload</mat-icon>
      Choose File
    </label>
    <input 
      appTrimInput 
      type="file" 
      id="file-input" 
      (change)="onFileSelected($event)" 
      accept=".xlsx, .xls" 
      hidden 
    />
    <button 
      class="upload-btn" 
      (click)="uploadFile()" 
      [disabled]="!selectedFile">
      <mat-icon>upload</mat-icon>
      Upload
    </button>
  </div>

  <!-- Registration Form Card -->
  <div class="card">
    <!-- Header -->
    <div class="card-header">
      <h2 class="text-center">Vendor Registration Form</h2>
      <div class="text-center mt-2">
        <button 
          mat-raised-button 
          color="primary" 
          (click)="toggleEditMode()" 
          class="me-2">
          {{ isEditMode ? 'Cancel Edit' : 'Edit Vendor' }}
        </button>
      </div>
    </div>

    <!-- Form Body -->
    <div class="card-body">
      <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()">
        <div class="row">
          
          <!-- Vendor Code Field - Show as dropdown in edit mode -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Vendor Code</mat-label>
              <mat-icon matPrefix>code</mat-icon>
              
              <!-- Edit Mode: Dropdown -->
              <mat-select 
                *ngIf="isEditMode" 
                formControlName="vendorCode" 
                (selectionChange)="onVendorCodeSelected($event.value)">
                <mat-option value="">Select Vendor Code</mat-option>
                <mat-option *ngFor="let vendor of vendorList" [value]="vendor.vendorCode">
                  {{ vendor.vendorCode }} - {{ vendor.companyName }}
                </mat-option>
              </mat-select>
              
              <!-- Create Mode: Read-only Input -->
              <input 
                *ngIf="!isEditMode"
                appTrimInput 
                matInput 
                formControlName="vendorCode" 
                readonly 
                placeholder="Auto-generated Vendor Code" 
              />
            </mat-form-field>
          </div>

          <!-- Company Name Field -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Company Name</mat-label>
              <mat-icon matPrefix>business</mat-icon>
              <input 
                appTrimInput 
                matInput 
                formControlName="companyName" 
                required
              />
              <mat-error *ngIf="registrationForm.get('companyName')?.touched && registrationForm.get('companyName')?.invalid">
                <small>Company Name is required.</small>
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Mailing Address Field -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Mailing Address</mat-label>
              <mat-icon matPrefix>location_on</mat-icon>
              <textarea 
                matInput 
                formControlName="mailingAddress" 
                rows="1" 
                required>
              </textarea>
              <mat-error *ngIf="registrationForm.get('mailingAddress')?.touched && registrationForm.get('mailingAddress')?.invalid">
                <small>Mailing Address is required.</small>
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Telephone Field -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Telephone</mat-label>
              <mat-icon matPrefix>call</mat-icon>
              <input 
                appTrimInput 
                matInput 
                formControlName="telephone" 
                required 
              />
              <mat-error *ngIf="registrationForm.get('telephone')?.touched && registrationForm.get('telephone')?.invalid">
                <small>Telephone is required.</small>
              </mat-error>
            </mat-form-field>
          </div>
    
          <!-- Email - Always editable -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Email</mat-label>
              <mat-icon matPrefix>email</mat-icon>
              <input 
                appTrimInput 
                matInput 
                id="email" 
                type="email" 
                formControlName="email" 
                (blur)="!isEditMode && checkEmailExists(registrationForm.get('email')?.value, 'vendor')"
                required 
              />
              <mat-error *ngIf="registrationForm.get('email')?.touched && registrationForm.get('email')?.invalid">
                <small *ngIf="registrationForm.get('email')?.hasError('required')">Email is required.</small>
                <small *ngIf="registrationForm.get('email')?.hasError('email')">Enter a valid email.</small>
                <small *ngIf="registrationForm.get('email')?.hasError('emailTaken') && !isEditMode">This email is already taken.</small>
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Website Field -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Website</mat-label>
              <mat-icon matPrefix>public</mat-icon>
              <input 
                appTrimInput 
                matInput 
                formControlName="website" 
              />
            </mat-form-field>
          </div>

          <!-- Point of Contact Name & Title Field -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Point of Contact Name & Title</mat-label>
              <mat-icon matPrefix>badge</mat-icon>
              <input 
                appTrimInput 
                matInput 
                formControlName="contactNameTitle" 
                required
              />
              <mat-error *ngIf="registrationForm.get('contactNameTitle')?.touched && registrationForm.get('contactNameTitle')?.invalid">
                <small>Contact Name & Title is required.</small>
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Contact Email Field -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Contact Email</mat-label>
              <mat-icon matPrefix>alternate_email</mat-icon>
              <input 
                appTrimInput 
                matInput 
                formControlName="contactEmail" 
                type="email" 
                required
              />
              <mat-error *ngIf="registrationForm.get('contactEmail')?.touched && registrationForm.get('contactEmail')?.invalid">
                <small *ngIf="registrationForm.get('contactEmail')?.hasError('required')">Contact Email is required.</small>
                <small *ngIf="registrationForm.get('contactEmail')?.hasError('email')">Enter a valid email.</small>
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Contact Phone 1 Field - Now Optional -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Contact Phone 1</mat-label>
              <mat-icon matPrefix>phone</mat-icon>
              <input 
                appTrimInput 
                matInput 
                formControlName="contactPhone1" 
              />
            </mat-form-field>
          </div>

          <!-- Service Type Dropdown -->
          <div class="col-lg-4">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Service Type</mat-label>
              <mat-icon matPrefix>category</mat-icon>
              <mat-select formControlName="serviceType" required>
                <mat-option value="">Select Service Type</mat-option>
                <mat-option value="Services">Services</mat-option>
                <mat-option value="Composite Services">Composite Services</mat-option>
                <mat-option value="Goods">Goods</mat-option>
                <mat-option value="Works">Works</mat-option>
              </mat-select>
              <mat-error *ngIf="registrationForm.get('serviceType')?.touched && registrationForm.get('serviceType')?.invalid">
                <small>Service Type is required.</small>
              </mat-error>
            </mat-form-field>
          </div>

          <!-- General Details Field -->
          <div class="col-lg-8">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>General Details of Services/Goods/Works</mat-label>
              <mat-icon matPrefix>description</mat-icon>
              <textarea 
                matInput 
                rows="1" 
                formControlName="generalDetails">
              </textarea>
            </mat-form-field>
          </div>

          <!-- Hidden Fields -->
          <input type="hidden" formControlName="username" />
          <input type="hidden" formControlName="HashedPassword" />
          <input type="hidden" formControlName="userType" />
          <input type="hidden" formControlName="salt" />
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-3">
          <button 
            mat-raised-button 
            color="primary" 
            type="submit"
            [disabled]="registrationForm.invalid || isSubmitting">
            {{ isEditMode ? 'Update Vendor' : 'Register' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>