<!-- dashboard-main.component.html -->
<div class="dashboard-container">
  <!-- Header Section - Hidden for vendor users -->
  <div class="dashboard-header" *ngIf="!isVendorUser">
    <div class="header-content">
      <h1 class="dashboard-title">
        <span class="material-icons">dashboard</span>
        Dashboard Overview
      </h1>
      <button class="refresh-btn" (click)="refreshDashboard()" [disabled]="isLoadingStats">
        <span class="material-icons">refresh</span>
        Refresh
      </button>
    </div>
  </div>

  <!-- Statistics Cards - Hidden for vendor users -->
  <div class="stats-grid" *ngIf="!isLoadingStats && !isVendorUser">
    <div class="stat-card stat-primary">
      <div class="stat-icon">
        <span class="material-icons">description</span>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ dashboardStats.totalPOs }}</h3>
        <p class="stat-label">Total Purchase Orders</p>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">
        <span class="material-icons">business</span>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ dashboardStats.totalVendors }}</h3>
        <p class="stat-label">Total Vendors</p>
      </div>
    </div>

    <div class="stat-card stat-info">
      <div class="stat-icon">
        <span class="material-icons">check_circle</span>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ dashboardStats.totalCompletedPOs }}</h3>
        <p class="stat-label">Completed POs</p>
      </div>
    </div>

    <div class="stat-card stat-warning">
      <div class="stat-icon">
        <span class="material-icons">pending</span>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ dashboardStats.totalPendingPOs }}</h3>
        <p class="stat-label">Pending POs</p>
      </div>
    </div>

    <div class="stat-card stat-danger">
      <div class="stat-icon">
        <span class="material-icons">warning</span>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ dashboardStats.totalOverduePOs }}</h3>
        <p class="stat-label">Overdue POs</p>
      </div>
    </div>

    <div class="stat-card stat-users">
      <div class="stat-icon">
        <span class="material-icons">people</span>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ dashboardStats.totalUsers }}</h3>
        <p class="stat-label">Total Users</p>
      </div>
    </div>
  </div>

  <!-- Loading Spinner - Hidden for vendor users -->
  <div class="loading-spinner" *ngIf="isLoadingStats && !isVendorUser">
    <p>Loading dashboard data...</p>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">
    <!-- Vendor & PO Selection Card -->
    <div class="dashboard-card selection-card">
      <div class="card-header">
        <h3 class="card-title">
          <span class="material-icons">search</span>
          <span *ngIf="!isVendorUser">Select Vendor & Purchase Order</span>
          <span *ngIf="isVendorUser">Select Purchase Order</span>
        </h3>
      </div>
      <div class="card-body">
        <form [formGroup]="vendorPoForm">
          <div class="form-row">
            <!-- Vendor Selection - Hidden for vendor users -->
            <div class="form-group" *ngIf="!isVendorUser">
              <mat-form-field  class="full-width">
                <mat-label>Select Vendor</mat-label>
                <input appTrimInput 
                       type="text"
                       placeholder="Search vendor..."
                       matInput
                       [formControl]="vendorControl"
                       [matAutocomplete]="vendorAuto"
                       (focus)="showAllVendors()">
                <mat-icon matPrefix>business</mat-icon>
                <mat-autocomplete #vendorAuto="matAutocomplete"
                                 (optionSelected)="onVendorSelect($event)"
                                 [displayWith]="displayVendor">
                  <mat-option *ngFor="let vendor of filteredVendors$ | async" 
                              [value]="vendor.id">
                    <div class="vendor-option">
                      <span class="vendor-code">{{ vendor.vendorCode }}</span>
                      <span class="vendor-name">{{ vendor.companyName }}</span>
                    </div>
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </div>

            <!-- PO Selection -->
            <div class="form-group" [class.full-width-vendor]="isVendorUser">
              <mat-form-field  class="full-width">
                <mat-label>Select Purchase Order</mat-label>
                <mat-select formControlName="po" 
                           [disabled]="!vendorPoForm.get('vendor')?.value">
                  <mat-icon matPrefix>description</mat-icon>
                  <mat-option *ngFor="let po of purchaseOrders" [value]="po.id">
                    {{ po.pO_NO }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Action Button -->
          <div class="action-buttons" *ngIf="isStepBarVisible()">
            <button class="btn-go" 
                    [routerLink]="['/stages', 1, vendorPoForm.get('po')?.value]"
                    [disabled]="!vendorPoForm.get('po')?.value">
              <span class="material-icons">arrow_forward</span>
              View Stages
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Latest Progress POs Card -->
    <div class="dashboard-card" *ngIf="!isVendorUser">
      <div class="card-header">
        <h3 class="card-title">
          <span class="material-icons">trending_up</span>
          Latest Purchase Orders Progress
          <span class="po-count-badge">{{ latestProgressPOs.length }}</span>
        </h3>
      </div>
      <div class="card-body">
        <div class="po-list" *ngIf="latestProgressPOs.length > 0 && !isLoadingLatestProgress">
          <div class="po-item progress-item" *ngFor="let po of latestProgressPOs" 
               (click)="navigateToLatestProgressPO(po)">
            <div class="po-info">
              <h4 class="po-number">{{ po.poNo }}</h4>
              <p class="po-date">
                <span class="material-icons">event</span>
                Created: {{ po.createdAt | date: 'MMM dd, yyyy' }}
              </p>
              <p class="po-stages">
                <span class="material-icons">layers</span>
                {{ po.completedStages }} / {{ po.totalStages }} stages completed
              </p>
            </div>
            <div class="po-status">
              <span class="status-badge" [ngClass]="getProgressStatusClass(po.completionPercentage)">
                {{ getProgressStatusText(po.completionPercentage) }}
              </span>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="po.completionPercentage"></div>
              </div>
              <span class="progress-text">{{ po.completionPercentage }}%</span>
            </div>
          </div>
        </div>
        <div class="loading-spinner-small" *ngIf="isLoadingLatestProgress">
          <span class="material-icons rotating">refresh</span>
          <p>Loading latest progress...</p>
        </div>
        <div class="empty-state" *ngIf="latestProgressPOs.length === 0 && !isLoadingLatestProgress">
          <span class="material-icons">inbox</span>
          <p>No recent purchase orders found</p>
        </div>
      </div>
    </div>

    <!-- My Assigned POs Card -->
    <div class="dashboard-card" *ngIf="!isVendorUser">
      <div class="card-header">
        <h3 class="card-title">
          <span class="material-icons">assignment</span>
          Assigned Purchase Orders
          <span class="po-count-badge">{{ userAssignedPOs.length }}</span>
        </h3>
      </div>
      <div class="card-body">
        <!-- User Filter Dropdown -->
        <div class="user-filter-section">
          <mat-form-field appearance="outline" class="user-select-field">
            <mat-label>Filter by User</mat-label>
            <mat-select [(value)]="selectedUserIdForPOs" 
                       (selectionChange)="onUserFilterChange($event.value)">
              <mat-icon matPrefix>person</mat-icon>
              <mat-option [value]="userId">My POs</mat-option>
              <mat-option *ngFor="let user of allUsers" [value]="user.id">
                {{ user.username }} 
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="po-list" *ngIf="userAssignedPOs.length > 0 && !isLoadingUserPOs">
          <div class="po-item" *ngFor="let po of userAssignedPOs" 
               (click)="navigateToUserPO(po)">
            <div class="po-info">
              <h4 class="po-number">{{ po.pO_NO }}</h4>
              <p class="po-vendor">{{ getVendorName(po.vendorId) }}</p>
              <p class="po-date">
                <span class="material-icons">event</span>
                Due: {{ po.contractualDeliveryDate | date: 'MMM dd, yyyy' }}
              </p>
              <p class="po-stages">
                <span class="material-icons">layers</span>
                {{ po.completedStages }} / {{ po.totalStages }} stages completed
              </p>
              <p class="po-amount" *ngIf="po.totalAmount">
                <span class="material-icons">attach_money</span>
                {{ po.totalAmount | currency }}
              </p>
            </div>
            <div class="po-status">
              <span class="status-badge" [ngClass]="'status-' + getPOStatus(po).toLowerCase().replace(' ', '-')">
                {{ getPOStatus(po) }}
              </span>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="po.progress"></div>
              </div>
              <span class="progress-text">{{ po.progress }}%</span>
            </div>
          </div>
        </div>
        <div class="loading-spinner-small" *ngIf="isLoadingUserPOs">
          <span class="material-icons rotating">refresh</span>
          <p>Loading your POs...</p>
        </div>
        <div class="empty-state" *ngIf="userAssignedPOs.length === 0 && !isLoadingUserPOs">
          <span class="material-icons">assignment_late</span>
          <p>No purchase orders assigned to you</p>
        </div>
      </div>
    </div>

    <!-- Recent POs Card - Hidden for vendor users -->
    <div class="dashboard-card" *ngIf="!isVendorUser">
      <div class="card-header">
        <h3 class="card-title">
          <span class="material-icons">schedule</span>
          Recent Purchase Orders
        </h3>
      </div>
      <div class="card-body">
        <div class="po-list" *ngIf="recentPOs.length > 0">
          <div class="po-item" *ngFor="let po of recentPOs" 
               (click)="navigateToPO(po.poNumber)">
            <div class="po-info">
              <h4 class="po-number">{{ po.poNumber }}</h4>
              <p class="po-vendor">{{ po.vendorName }}</p>
              <p class="po-date">
                <span class="material-icons">event</span>
                Due: {{ po.dueDate | date: 'MMM dd, yyyy' }}
              </p>
              <p class="po-stages">
                <span class="material-icons">layers</span>
                {{ po.completedStages }} / {{ po.totalStages }} stages completed
              </p>
            </div>
            <div class="po-status">
              <span class="status-badge" [ngClass]="'status-' + po.status.toLowerCase().replace(' ', '-')">
                {{ po.status }}
              </span>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="po.progress"></div>
              </div>
              <span class="progress-text">{{ po.progress }}%</span>
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="recentPOs.length === 0">
          <span class="material-icons">inbox</span>
          <p>No recent purchase orders</p>
        </div>
      </div>
    </div>

    <!-- Overdue POs Card - Hidden for vendor users -->
    <div class="dashboard-card" *ngIf="overduePOs.length > 0 && !isVendorUser">
      <div class="card-header alert-header">
        <h3 class="card-title">
          <span class="material-icons">warning</span>
          Overdue Purchase Orders
        </h3>
      </div>
      <div class="card-body">
        <div class="po-list overdue-list">
          <div class="po-item overdue-item" *ngFor="let po of overduePOs"
               (click)="navigateToPO(po.poNumber)">
            <div class="po-info">
              <h4 class="po-number">{{ po.poNumber }}</h4>
              <p class="po-vendor">{{ po.vendorName }}</p>
              <p class="po-overdue">
                <span class="material-icons">alarm</span>
                Overdue by {{ getDaysOverdue(po.dueDate) }} days
              </p>
              <p class="po-stages">
                <span class="material-icons">layers</span>
                {{ po.completedStages }} / {{ po.totalStages }} stages completed
              </p>
            </div>
            <div class="po-status">
              <span class="status-badge status-overdue">{{ po.status }}</span>
              <div class="progress-bar">
                <div class="progress-fill danger" [style.width.%]="po.progress"></div>
              </div>
              <span class="progress-text">{{ po.progress }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PO Statistics Overview - Hidden for vendor users -->
    <div class="dashboard-card stages-card" *ngIf="!isVendorUser">
      <div class="card-header">
        <h3 class="card-title">
          <span class="material-icons">analytics</span>
          Purchase Order Statistics
        </h3>
      </div>
      <div class="card-body">
        <div class="stage-summary">
          <div class="summary-item">
            <div class="summary-circle completed">
              <span class="material-icons">check_circle</span>
            </div>
            <div class="summary-info">
              <h4>{{ dashboardStats.totalCompletedPOs }}</h4>
              <p>Completed</p>
            </div>
          </div>
          <div class="summary-item">
            <div class="summary-circle pending">
              <span class="material-icons">schedule</span>
            </div>
            <div class="summary-info">
              <h4>{{ dashboardStats.totalPendingPOs }}</h4>
              <p>Pending</p>
            </div>
          </div>
          <div class="summary-item">
            <div class="summary-circle overdue">
              <span class="material-icons">warning</span>
            </div>
            <div class="summary-info">
              <h4>{{ dashboardStats.totalOverduePOs }}</h4>
              <p>Overdue</p>
            </div>
          </div>
        </div>

        <div class="completion-rate">
          <div class="rate-label">
            <span>Overall Completion Rate</span>
            <span class="rate-value">
              {{ getCompletionRate() }}%
            </span>
          </div>
          <div class="progress-bar large">
            <div class="progress-fill" 
                 [style.width.%]="getCompletionRate()">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include reports component - Hidden for vendor users -->
<app-reports *ngIf="!isVendorUser"></app-reports>