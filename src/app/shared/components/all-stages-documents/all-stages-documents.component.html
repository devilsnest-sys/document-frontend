<div class="all-stages-document-container m-0">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p class="mt-2">Loading documents from all stages...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage" class="error-message alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i>
    {{ errorMessage }}
  </div>

  <!-- Header -->
   <div class="card p-1 mb-2">
     <h5 class="text-center">
      <i class="fas fa-folder-open"></i>
      All Stages Document Management
    </h5>
   </div>
  <!-- <div class="card mb-4">
   
    <p class="text-center text-muted">
      View and manage documents across all stages for PO: {{ poNumber }}
    </p>
  </div> -->

  <!-- Main Content -->
  <div class="data-grid" *ngIf="!isLoading && !errorMessage">
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead class="thead-dark">
          <tr>
            <th style="width: 3%;">Sr No.</th>
            <th style="width: 8%;">Stage</th>
            <th style="width: 12%;">Document Type</th>
            <th style="width: 6%;">Upload</th>
            <th style="width: 12%;">Document Name</th>
            <th style="width: 6%;">Status</th>
            <th style="width: 8%;">Uploaded By</th>
            <th style="width: 8%;">Upload Date</th>
            <th style="width: 8%;">Reviewed By</th>
            <th style="width: 8%;">Review Date</th>
            <th style="width: 10%;">Remarks</th>
            <th style="width: 11%;">Actions</th>
          </tr>
        </thead>

        <tbody>
          <!-- Loop through each stage -->
          <ng-container *ngFor="let stage of stageGroups; let stageIndex = index">
            <!-- Stage Header Row -->
            <tr (click)="toggleStage(stage.stageId)" class="stage-header-row" [class.expanded]="isStageExpanded(stage.stageId)"
              [class.status-completed]="getStageStatus(stage.stageId) === 'Complete'"
              [class.status-inprogress]="getStageStatus(stage.stageId) === 'InProgress'"
              [class.status-pending]="getStageStatus(stage.stageId) === 'Pending' || !getStageStatus(stage.stageId)">
              <td colspan="13" class="stage-header-cell">
                <div class="stage-header-content d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas" [class.fa-chevron-down]="isStageExpanded(stage.stageId)"
                      [class.fa-chevron-right]="!isStageExpanded(stage.stageId)"></i>
                    <span class="stage-name">{{ stage.stageName }}</span>
                    <span class="badge badge-info ml-2 mx-2">
                      {{ stage.documents.length }} Document Types
                    </span>
                    <!-- BUG FIX: Show stage status badge -->
                    <span class="badge ml-2" 
                          [class.badge-success]="getStageStatus(stage.stageId) === 'Complete'"
                          [class.badge-warning]="getStageStatus(stage.stageId) === 'InProgress'"
                          [class.badge-secondary]="getStageStatus(stage.stageId) === 'Pending'">
                      {{ getStageStatus(stage.stageId) }}
                    </span>
                  </div>
        
                  <!-- BUG FIX: Submit Stage Button - Only for 'user' role -->
                  <button class="btn btn-sm" 
                          [class.btn-success]="getStageStatus(stage.stageId) !== 'Complete'"
                          [class.btn-secondary]="getStageStatus(stage.stageId) === 'Complete'"
                          (click)="submitStage(stage.stageId); $event.stopPropagation();" 
                          *ngIf="isUser()"
                          [disabled]="isSubmitDisabled(stage.stageId)"
                          [title]="getStageStatus(stage.stageId) === 'Complete' ? 'Stage already submitted' : 
                                   !canSubmitStage(stage.stageId) ? 'All documents must be approved before submission' : 
                                   'Submit this stage'">
                    <i class="fas" [class.fa-check-circle]="getStageStatus(stage.stageId) !== 'Complete'"
                                   [class.fa-check-double]="getStageStatus(stage.stageId) === 'Complete'"></i> 
                    {{ getSubmitButtonText(stage.stageId) }}
                  </button>
                </div>
              </td>
            </tr>
        
            <!-- Document Type Groups within Stage -->
            <ng-container *ngIf="isStageExpanded(stage.stageId)">
              <ng-container *ngFor="let docGroup of stage.documents; let docGroupIndex = index">
                <!-- Document Type Header -->
                <tr (click)="toggleDocument(stage.stageId, docGroup.documentType.id)" class="document-type-header"
                  [class.expanded]="isDocumentExpanded(stage.stageId, docGroup.documentType.id)">
                  <td></td>
                  <td colspan="12" class="document-type-cell">
                    <div class="document-type-content">
                      <i class="fas fa-chevron-right toggle-icon"
                        [class.fa-chevron-down]="isDocumentExpanded(stage.stageId, docGroup.documentType.id)"></i>
                      <i class="fas fa-file-alt mr-2"></i>
                      <span class="doc-type-name">{{ docGroup.documentType.documentName }}</span>
                      <span class="badge badge-secondary ml-2">
                        {{ getDocumentCount(stage.stageId, docGroup.documentType.id) }} documents
                      </span>
                    </div>
                  </td>
                </tr>
        
                <!-- Uploaded Documents -->
                <tr *ngFor="let doc of docGroup.uploadedDocuments; let docIndex = index"
                  [hidden]="!isDocumentExpanded(stage.stageId, docGroup.documentType.id)" class="document-row"
                  [class.row-approved]="doc.isApproved" [class.row-rejected]="doc.isRejected"
                  [class.row-pending]="!doc.isApproved && !doc.isRejected">
                  <td>{{ docIndex + 1 }}</td>
                  <td>
                    <span class="badge badge-primary">Stage {{ stage.stageId }}</span>
                  </td>
                  <td>{{ docGroup.documentType.documentName }}</td>
                  <td>
                    <!-- BUG FIX: Upload button only for user role and appropriate conditions -->
                    <div class="upload-container">
                      <input appTrimInput #fileInput type="file"
                        [id]="'fileInput-' + stage.stageId + '-' + docGroup.documentType.id + '-' + docIndex"
                        style="display: none;" (change)="handleFileSelect($event, stage.stageId, docGroup.documentType.id)" />
                      <button class="btn btn-sm btn-outline-primary" (click)="fileInput.click()"
                        [disabled]="doc.isApproved || doc.status === 'Pending' || getStageStatus(stage.stageId) === 'Complete'"
                        [title]="doc.isApproved ? 'Upload disabled - Already approved' : 
                                 doc.status === 'Pending' ? 'Upload disabled - Document is pending' : 
                                 getStageStatus(stage.stageId) === 'Complete' ? 'Upload disabled - Stage completed' : 
                                 'Upload new document'">
                        <i class="fas fa-upload"></i>
                      </button>
                    </div>
                    <div *ngIf="!isUser()" class="text-muted">
                      <small>N/A</small>
                    </div>
                  </td>
                  <td>
                    <span class="doc-name" [title]="doc.uploadedDocumentName">
                      {{ doc.uploadedDocumentName }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" [class.badge-success]="doc.isApproved" [class.badge-danger]="doc.isRejected"
                      [class.badge-warning]="!doc.isApproved && !doc.isRejected">
                      {{ doc.status || 'N/A' }}
                    </span>
                  </td>
                  <td>
                    <div class="uploader-info">
                      <small class="text-muted d-block">{{ doc.userNameAccToUploadDoc || 'N/A' }}</small>
                      <span class="badge badge-light">{{ doc.docUploadedBy || 'N/A' }}</span>
                    </div>
                  </td>
                  <td>
                    <small>{{ doc.uploadedDate | date: 'short' }}</small>
                  </td>
                  <td>
                    <div class="reviewer-info">
                      <small class="text-muted d-block">{{ doc.vendorNameAccToReviewDoc || 'N/A' }}</small>
                      <span class="badge badge-light">{{ doc.docReviewedBy || 'N/A' }}</span>
                    </div>
                  </td>
                  <td>
                    <small>{{ doc.docReviewDate ? (doc.docReviewDate | date: 'short') : 'N/A' }}</small>
                  </td>
                  <td>
                    <span class="remarks-text" [title]="doc.reviewRemark">
                      {{ doc.reviewRemark || 'N/A' }}
                    </span>
                  </td>
                  <td>
                    <!-- BUG FIX: Action buttons with proper role checks -->
                    <div class="action-buttons d-flex flex-wrap gap-1">
                      <!-- View and Download available to all -->
                      <button class="btn btn-sm btn-info" (click)="viewDocument(doc.id)" title="View">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-secondary" (click)="downloadDocument(doc.id)" title="Download">
                        <i class="fas fa-download"></i>
                      </button>
                      
                      <!-- BUG FIX: Approve Button - Only for vendor role -->
                      <button class="btn btn-sm btn-success" 
                              (click)="approveDocument(doc)" 
                              *ngIf="isVendor()"
                              [disabled]="doc.isApproved || doc.isRejected"
                              [title]="doc.isApproved ? 'Already approved' : 
                                       doc.isRejected ? 'Document was rejected' : 
                                       'Approve document'">
                        <i class="fas fa-check"></i>
                      </button>
                      
                      <!-- BUG FIX: Reject Button - Only for vendor role -->
                      <button class="btn btn-sm btn-danger" 
                              (click)="rejectDocument(doc)" 
                              *ngIf="isVendor()"
                              [disabled]="doc.isApproved || doc.isRejected"
                              [title]="doc.isRejected ? 'Already rejected' : 
                                       doc.isApproved ? 'Document was approved' : 
                                       'Reject document'">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </td>
                </tr>
        
                <!-- BUG FIX: No Documents or Rejected - Show Upload Row (Only for user role) -->
                <tr *ngIf="isGroupVisible(stage.stageId, docGroup)"
                  [hidden]="!isDocumentExpanded(stage.stageId, docGroup.documentType.id)" class="upload-row">
                  <td></td>
                  <td>
                    <span class="badge badge-primary">Stage {{ stage.stageId }}</span>
                  </td>
                  <td>{{ docGroup.documentType.documentName }}</td>
                  <td>
                    <div class="upload-container">
                      <input appTrimInput #fileInputNew type="file"
                        [id]="'fileInputNew-' + stage.stageId + '-' + docGroup.documentType.id" style="display: none;"
                        (change)="handleFileSelect($event, stage.stageId, docGroup.documentType.id)" />
                      <button class="btn btn-sm btn-primary" (click)="fileInputNew.click()"
                        [disabled]="hasApprovedDocument(docGroup) || getStageStatus(stage.stageId) === 'Complete'"
                        [title]="hasApprovedDocument(docGroup) ? 'Document already approved' : 
                                 getStageStatus(stage.stageId) === 'Complete' ? 'Stage already completed' : 
                                 'Upload document'">
                        <i class="fas fa-upload"></i> Upload
                      </button>
                    </div>
                  </td>
                  <td colspan="9" class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    No documents uploaded yet or document was rejected. Upload to begin.
                  </td>
                </tr>
              </ng-container>
            </ng-container>
          </ng-container>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div
      *ngIf="!isLoading && !errorMessage && stageGroups.length === 0"
      class="empty-state text-center py-5"
    >
      <div class="mb-3">
        <i class="fas fa-folder-open fa-4x text-muted"></i>
      </div>
      <h4 class="text-muted">No Documents Available</h4>
      <p class="text-muted">No documents have been configured for any stage yet.</p>
    </div>
  </div>
</div>