<div class="all-stages-fields-container m-0">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p class="mt-2">Loading additional fields from all stages...</p>
  </div>

  <!-- Header -->
  <!-- <div class="page-header mb-4">
    <h2 class="text-center">
      <i class="fas fa-list-alt"></i>
      All Stages Additional Fields Management
    </h2>
    <p class="text-center text-muted">
      View and manage additional fields across all stages for PO: {{ poNumber }}
    </p>
  </div> -->
  <div class="card p-1 mb-2">
     <h5 class="text-center">
      <i class="fas fa-list-alt"></i>
      All Stages Additional Fields Management
    </h5>
  </div>
  <!-- Main Content -->
  <div class="data-grid" *ngIf="!loading">
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead class="thead-dark">
          <tr>
            <th style="width: 5%;">Sr No.</th>
            <th style="width: 10%;">Stage</th>
            <th style="width: 20%;">Field Name</th>
            <th style="width: 30%;">Initial Value</th>
            <th style="width: 15%;">Actions</th>
          </tr>
        </thead>

        <tbody>
          <!-- Loop through each stage -->
          <ng-container *ngFor="let stage of stageGroups; let stageIndex = index">
            <!-- Stage Header Row -->
            <tr
              (click)="toggleStage(stage.stageId)"
              class="stage-header-row"
              [class.expanded]="isStageExpanded(stage.stageId)"
            >
              <td colspan="5" class="stage-header-cell">
                <div class="stage-header-content d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas" [class.fa-chevron-down]="isStageExpanded(stage.stageId)"
                      [class.fa-chevron-right]="!isStageExpanded(stage.stageId)"></i>
                    <span class="stage-name mx-2">{{ stage.stageName }}</span>
                    <span class="badge badge-info ml-2">
                      {{ getFieldCountForStage(stage.stageId) }} Available Fields
                    </span>
                  </div>
                </div>
              </td>
            </tr>

            <!-- Fields within Stage -->
            <ng-container *ngIf="isStageExpanded(stage.stageId)">
              <ng-container *ngFor="let field of stage.availableFields; let fieldIndex = index">
                <!-- Field Header -->
                <tr
                  (click)="toggleField(stage.stageId, field.id)"
                  class="field-type-header"
                  [class.expanded]="isFieldExpanded(stage.stageId, field.id)"
                >
                  <td></td>
                  <td colspan="4" class="field-type-cell">
                    <div class="field-type-content">
                      <i
                        class="fas fa-chevron-right toggle-icon"
                        [class.fa-chevron-down]="isFieldExpanded(stage.stageId, field.id)"
                      ></i>
                      <i class="fas fa-clipboard-list mr-2 ml-2"></i>
                      <span class="field-name">{{ field.additionalFieldName }}</span>
                      <span class="badge badge-secondary ml-2">
                        {{ getUploadedFieldsForField(stage.stageId, field.id).length }} entries
                      </span>
                    </div>
                  </td>
                </tr>

                <!-- Uploaded Field Values -->
                <tr
                  *ngFor="let uploadedField of getUploadedFieldsForField(stage.stageId, field.id); let valueIndex = index"
                  [hidden]="!isFieldExpanded(stage.stageId, field.id)"
                  class="field-row"
                >
                  <td>{{ valueIndex + 1 }}</td>
                  <td>
                    <span class="badge badge-primary">Stage {{ stage.stageId }}</span>
                  </td>
                  <td>{{ field.additionalFieldName }}</td>
                  <td>
                    <input appTrimInput 
                      type="text" 
                      class="form-control"
                      [value]="uploadedField.initAddFieldValue"
                      disabled
                    />
                  </td>
                  <td>
                    <div class="action-buttons d-flex gap-2">
                      <button 
                        class="btn btn-outline-primary btn-sm" 
                        (click)="startEdit(valueIndex, uploadedField)"
                        [disabled]="loading || editingIndex !== null">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button 
                        class="btn btn-outline-danger btn-sm" 
                        (click)="deleteFieldFlow(uploadedField)"
                        [disabled]="loading">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>

                <!-- Add New Field Value Row -->
                <tr
                  *ngIf="isFieldVisible(stage.stageId, field)"
                  [hidden]="!isFieldExpanded(stage.stageId, field.id)"
                  class="upload-row"
                  [formGroup]="fieldForm"
                >
                  <td></td>
                  <td>
                    <span class="badge badge-primary">Stage {{ stage.stageId }}</span>
                  </td>
                  <td>{{ field.additionalFieldName }}</td>
                  <td>
                    <input appTrimInput 
                      type="text" 
                      class="form-control" 
                      formControlName="initAddFieldValue"
                      placeholder="Enter initial value"
                      [class.is-invalid]="isFieldInvalid('initAddFieldValue')"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('initAddFieldValue')">
                      {{ getFieldError('initAddFieldValue') }}
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <button 
                        type="button" 
                        class="btn btn-primary btn-sm" 
                        (click)="addRow(stage.stageId, field.id)"
                        [disabled]="loading || fieldForm.invalid">
                        <i class="fas" [ngClass]="editingIndex !== null ? 'fa-save' : 'fa-plus'"></i>
                        {{ editingIndex !== null ? 'Update' : 'Add' }}
                      </button>
                      <button 
                        *ngIf="editingIndex !== null"
                        type="button" 
                        class="btn btn-secondary btn-sm" 
                        (click)="cancelEdit()"
                        [disabled]="loading">
                        <i class="fas fa-times"></i> Cancel
                      </button>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </ng-container>
          </ng-container>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div
      *ngIf="!loading && stageGroups.length === 0"
      class="empty-state text-center py-5"
    >
      <div class="mb-3">
        <i class="fas fa-inbox fa-4x text-muted"></i>
      </div>
      <h4 class="text-muted">No Additional Fields Available</h4>
      <p class="text-muted">No additional fields have been configured for any stage yet.</p>
    </div>
  </div>
</div>